<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ª–æ–≥–∏—Å—Ç–∏–∫–∏ —Ç—Ä—É–±</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0F0F0F;color:#E5E5E5;font-family:'JetBrains Mono',monospace;font-size:13px}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:#1a1a1a}::-webkit-scrollbar-thumb{background:#D97706;border-radius:3px}
.app{max-width:1400px;margin:0 auto;padding:16px}
h1{color:#D97706;font-size:20px;font-weight:700;margin-bottom:4px}
.subtitle{color:#666;font-size:11px;margin-bottom:20px}
.card{background:#1a1a1a;border:1px solid #2a2a2a;border-radius:8px;padding:16px;margin-bottom:16px}
.card-title{color:#D97706;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
.vtabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.tab{padding:8px 20px;border:1px solid #333;border-radius:6px;cursor:pointer;background:#111;color:#888;font-family:inherit;font-size:12px;transition:all .2s}
.tab.active{background:#D97706;color:#000;border-color:#D97706;font-weight:600}
table{width:100%;border-collapse:collapse}
th{color:#888;font-size:11px;font-weight:500;text-align:left;padding:6px 8px;border-bottom:1px solid #2a2a2a;white-space:nowrap}
td{padding:4px;border-bottom:1px solid #1f1f1f;vertical-align:middle}
input[type=number],input[type=text],select{background:#111;border:1px solid #2a2a2a;color:#E5E5E5;padding:5px 8px;border-radius:4px;font-family:inherit;font-size:12px;width:100%;outline:none}
input:focus,select:focus{border-color:#D97706}
select option{background:#1a1a1a}
.btn{padding:7px 16px;border-radius:5px;border:none;cursor:pointer;font-family:inherit;font-size:12px;font-weight:600;transition:all .2s}
.btn-primary{background:#D97706;color:#000}.btn-primary:hover{background:#f59e0b}
.btn-secondary{background:#2a2a2a;color:#E5E5E5;border:1px solid #333}.btn-secondary:hover{background:#333}
.btn-danger{background:transparent;color:#ef4444;border:1px solid #ef444455;padding:4px 10px;font-size:11px}.btn-danger:hover{background:#ef444422}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px}
.stat{background:#111;border:1px solid #2a2a2a;border-radius:6px;padding:12px}
.stat-val{font-size:24px;font-weight:700;color:#D97706}
.stat-label{color:#666;font-size:10px;margin-top:2px}
.nbadge{display:inline-block;background:#1f2d1a;color:#4ade80;border:1px solid #4ade8033;padding:2px 8px;border-radius:10px;font-size:10px}
.err{background:#1a0a0a;border:1px solid #ef4444;border-radius:6px;padding:10px 14px;color:#ef4444;font-size:11px;margin-bottom:12px}
.pbar-wrap{height:6px;background:#1f1f1f;border-radius:3px;overflow:hidden;margin-bottom:12px}
.pbar{height:100%;border-radius:3px;transition:width .5s}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useRef } = React;

const VEHICLES = {
  truck: { name:'–§—É—Ä–∞',      icon:'üöõ', l:13600, w:2440, h:2580, maxW:22000 },
  wagon: { name:'–ü–æ–ª—É–≤–∞–≥–æ–Ω', icon:'üöÉ', l:12680, w:2830, h:2170, maxW:63000 }
};
const MATERIALS = [
  {id:'steel',rho:7850,name:'–°—Ç–∞–ª—å'},{id:'stainless',rho:7900,name:'–ù–µ—Ä–∂–∞–≤–µ–π–∫–∞'},
  {id:'copper',rho:8900,name:'–ú–µ–¥—å'},{id:'aluminum',rho:2700,name:'–ê–ª—é–º–∏–Ω–∏–π'},
  {id:'brass',rho:8500,name:'–õ–∞—Ç—É–Ω—å'},{id:'titanium',rho:4500,name:'–¢–∏—Ç–∞–Ω'},
  {id:'cast_iron',rho:7200,name:'–ß—É–≥—É–Ω'},{id:'nickel',rho:8900,name:'–ù–∏–∫–µ–ª—å'},
  {id:'zinc',rho:7130,name:'–¶–∏–Ω–∫'},{id:'lead',rho:11340,name:'–°–≤–∏–Ω–µ—Ü'},
];
const COLORS=['#60a5fa','#fbbf24','#4ade80','#fb923c','#a78bfa','#34d399','#f472b6','#f87171','#38bdf8','#e879f9'];
const getMat = id => MATERIALS.find(m=>m.id===id)||MATERIALS[0];
const calcWpm = (D,t,rho) => Math.PI*t*(D-t)/1e6*rho;
const calcW   = (D,t,L,n,rho) => calcWpm(D,t,rho)*(L/1000)*n;

// ‚îÄ‚îÄ‚îÄ Gravity Simulator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –ö–∞–∂–¥–∞—è —Ç—Ä—É–±–∞: {cx, cy, r, diameter, posId}
// cx,cy ‚Äî –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –≤ –º–º; y=0 ‚Äî –ø–æ–ª, y —Ä–∞—Å—Ç—ë—Ç –≤–≤–µ—Ä—Ö

function gravSim(W, H, initPipes) {
  var pipes = initPipes ? initPipes.map(function(p){ return {cx:p.cx,cy:p.cy,r:p.r,diameter:p.diameter,posId:p.posId}; }) : [];

  function findY(cx, r) {
    var best = r;
    for (var i = 0; i < pipes.length; i++) {
      var p = pipes[i];
      var dx = Math.abs(cx - p.cx);
      var md = r + p.r;
      if (dx < md) {
        var candidate = p.cy + Math.sqrt(md*md - dx*dx);
        if (candidate > best) best = candidate;
      }
    }
    return best;
  }

  function bestPos(r) {
    // –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –ø–æ X: —Å—Ç–µ–Ω—ã + –≤–ø–ª–æ—Ç–Ω—É—é –∫ –∫–∞–∂–¥–æ–π —Ç—Ä—É–±–µ + ¬´—Å–µ–¥–ª–æ¬ª –º–µ–∂–¥—É –ø–∞—Ä–∞–º–∏
    var cands = [r, W - r];
    for (var i = 0; i < pipes.length; i++) {
      var p = pipes[i];
      cands.push(p.cx - p.r - r);
      cands.push(p.cx + p.r + r);
      for (var j = i+1; j < pipes.length; j++) {
        var q = pipes[j];
        var a = p.r + r, b = q.r + r;
        var D = Math.abs(p.cx - q.cx);
        if (D < a+b && D > Math.abs(a-b)) {
          var cx = p.cx + (D*D + a*a - b*b)/(2*D) * (q.cx > p.cx ? 1 : -1);
          cands.push(cx);
        }
      }
    }
    var best = null;
    for (var k = 0; k < cands.length; k++) {
      var cx = cands[k];
      if (cx - r < -0.1 || cx + r > W + 0.1) continue;
      var cy = findY(cx, r);
      if (cy + r > H + 0.1) continue;
      // –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π
      var ok = true;
      for (var m = 0; m < pipes.length; m++) {
        var pp = pipes[m];
        var ddx = cx - pp.cx, ddy = cy - pp.cy;
        if (Math.sqrt(ddx*ddx + ddy*ddy) < r + pp.r - 0.5) { ok = false; break; }
      }
      if (!ok) continue;
      if (!best || cy < best.cy || (Math.abs(cy - best.cy) < 0.5 && cx < best.cx)) best = {cx:cx, cy:cy};
    }
    return best;
  }

  return {
    getPipes: function() { return pipes; },
    calcFit: function(diameter, maxCount) {
      // –ø—Ä–æ–±–Ω—ã–π –ø—Ä–æ–≥–æ–Ω –Ω–∞ –∫–æ–ø–∏–∏
      var clone = gravSim(W, H, pipes);
      var r = diameter / 2, count = 0;
      while (count < maxCount) {
        var pos = clone.tryPlace(r);
        if (!pos) break;
        clone.getPipes().push({cx:pos.cx, cy:pos.cy, r:r, diameter:diameter});
        count++;
      }
      return count;
    },
    tryPlace: function(r) { return bestPos(r); },
    commit: function(posId, diameter, maxCount) {
      var r = diameter / 2, placed = 0;
      while (placed < maxCount) {
        var pos = bestPos(r);
        if (!pos) break;
        pipes.push({cx:pos.cx, cy:pos.cy, r:r, diameter:diameter, posId:posId});
        placed++;
      }
      return placed;
    }
  };
}

// ‚îÄ‚îÄ‚îÄ Load one vehicle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadVehicle(positions, vKey) {
  var v = VEHICLES[vKey];
  var sim = gravSim(v.w, v.h, []);
  var totalWeight = 0;
  var loaded = [];

  // —Å–æ—Ä—Ç–∏—Ä—É–µ–º: –∫—Ä—É–ø–Ω—ã–µ –≤–Ω–∏–∑
  var sorted = positions.slice().sort(function(a,b){ return b.diameter - a.diameter; });
  var remaining = sorted.map(function(p){ return {p:p, rem:p.count}; });

  var guard = 0;
  while (guard++ < 200) {
    var anyPlaced = false;
    var stillLeft = [];
    for (var i = 0; i < remaining.length; i++) {
      var item = remaining[i], p = item.p;
      var wPer = calcWpm(p.diameter, p.thickness, p.rho) * (p.length/1000);
      var maxByW = wPer > 0 ? Math.floor((v.maxW - totalWeight) / wPer) : item.rem;
      var canTake = Math.min(item.rem, maxByW);
      if (canTake < 1) { stillLeft.push(item); continue; }
      var fit = sim.calcFit(p.diameter, canTake);
      if (fit < 1) { stillLeft.push(item); continue; }
      var actual = sim.commit(p.id, p.diameter, fit);
      if (actual < 1) { stillLeft.push(item); continue; }
      totalWeight += actual * wPer;
      var ex = null;
      for (var j=0; j<loaded.length; j++) { if(loaded[j].id===p.id){ex=loaded[j];break;} }
      if (ex) ex.loaded += actual;
      else loaded.push({id:p.id,name:p.name,diameter:p.diameter,thickness:p.thickness,
        length:p.length,loaded:actual,wPerPipe:wPer,rho:p.rho});
      if (actual < item.rem) stillLeft.push({p:p, rem:item.rem - actual});
      anyPlaced = true;
    }
    remaining = stillLeft;
    if (!anyPlaced || remaining.length === 0) break;
  }

  var pipes = sim.getPipes();
  var usedH = pipes.length ? Math.max.apply(null, pipes.map(function(pp){return pp.cy+pp.r;})) : 0;
  return {loaded:loaded, totalWeight:totalWeight, pipes:pipes, usedH:usedH};
}

// ‚îÄ‚îÄ‚îÄ Optimize: split into multiple vehicles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function optimizeLoading(positions, vKey) {
  var vehicles = [];
  var rem = positions.map(function(p){ return {p:p, count:p.count}; });
  var guard = 0;
  while (guard++ < 500) {
    var active = [];
    for (var i=0; i<rem.length; i++) { if(rem[i].count>0) active.push({id:rem[i].p.id,name:rem[i].p.name,diameter:rem[i].p.diameter,thickness:rem[i].p.thickness,length:rem[i].p.length,rho:rem[i].p.rho,count:rem[i].count}); }
    if (!active.length) break;
    var res = loadVehicle(active, vKey);
    if (!res.loaded.length) break;
    vehicles.push({number:vehicles.length+1, loaded:res.loaded, totalWeight:res.totalWeight, pipes:res.pipes, usedH:res.usedH});
    for (var j=0; j<rem.length; j++) {
      for (var k=0; k<res.loaded.length; k++) {
        if (res.loaded[k].id === rem[j].p.id) { rem[j].count -= res.loaded[k].loaded; break; }
      }
    }
  }
  return vehicles;
}

// ‚îÄ‚îÄ‚îÄ Visualization: Front ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function VizFront(props) {
  var pipes=props.pipes, vKey=props.vKey, colorMap=props.colorMap;
  var v=VEHICLES[vKey], sc=150/v.h, W=v.w*sc, H=v.h*sc, pad=28;
  return (
    <svg width={W+pad*2} height={H+pad*2} style={{display:'block'}}>
      <rect x={pad} y={pad} width={W} height={H} fill="#0d0d0d" stroke="#444" strokeWidth={1}/>
      {pipes.map(function(p,i){
        var cx=pad+p.cx*sc, cy=pad+H-p.cy*sc, r=Math.max(p.r*sc-0.5,0.5);
        var color=colorMap[p.diameter]||'#888';
        return (
          <g key={i}>
            <circle cx={cx} cy={cy} r={r} fill={color} fillOpacity={0.75} stroke={color} strokeWidth={0.5}/>
            {r>10 && <text x={cx} y={cy+3} textAnchor="middle" fontSize={Math.min(r*0.7,10)} fill="#000" fontWeight="700" fontFamily="monospace">{p.diameter}</text>}
          </g>
        );
      })}
      <text x={pad+W/2} y={pad+H+17} textAnchor="middle" fontSize={9} fill="#555" fontFamily="monospace">{v.w} –º–º</text>
      <text x={pad-16} y={pad+H/2} textAnchor="middle" fontSize={9} fill="#555" fontFamily="monospace" transform={"rotate(-90,"+(pad-16)+","+(pad+H/2)+")"}>{v.h} –º–º</text>
    </svg>
  );
}

// ‚îÄ‚îÄ‚îÄ Visualization: Side ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function VizSide(props) {
  var pipes=props.pipes, vKey=props.vKey, colorMap=props.colorMap;
  var v=VEHICLES[vKey], scH=150/v.h, scL=Math.min(0.06,200/v.l), W=v.l*scL, H=v.h*scH, pad=28;
  // –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–∏–∞–º–µ—Ç—Ä—É
  var byD={};
  for (var i=0; i<pipes.length; i++) {
    var p=pipes[i];
    if (!byD[p.diameter]) byD[p.diameter]={minY:Infinity,maxY:0,color:colorMap[p.diameter]||'#888'};
    if (p.cy-p.r < byD[p.diameter].minY) byD[p.diameter].minY=p.cy-p.r;
    if (p.cy+p.r > byD[p.diameter].maxY) byD[p.diameter].maxY=p.cy+p.r;
  }
  var bands = Object.keys(byD).map(function(d){ return {d:d,info:byD[d]}; });
  return (
    <svg width={W+pad*2} height={H+pad*2} style={{display:'block'}}>
      <rect x={pad} y={pad} width={W} height={H} fill="#0d0d0d" stroke="#444" strokeWidth={1}/>
      {bands.map(function(b,i){
        var y=pad+H-b.info.maxY*scH, h=(b.info.maxY-b.info.minY)*scH;
        return (
          <g key={i}>
            <rect x={pad} y={y} width={W} height={Math.max(h,1)} fill={b.info.color} fillOpacity={0.4} stroke={b.info.color} strokeWidth={0.5}/>
            <text x={pad+6} y={y+h/2+4} fontSize={9} fill={b.info.color} fontFamily="monospace">√ò{b.d}</text>
          </g>
        );
      })}
      <text x={pad+W/2} y={pad+H+17} textAnchor="middle" fontSize={9} fill="#555" fontFamily="monospace">{v.l} –º–º</text>
    </svg>
  );
}

// ‚îÄ‚îÄ‚îÄ App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var uid = 1;
function newRow(){ return {id:uid++,name:'',diameter:219,thickness:6,length:12000,count:1,material:'steel'}; }

function App() {
  var state = useState('truck');
  var vKey=state[0], setVKey=state[1];
  var rstate = useState([newRow()]);
  var rows=rstate[0], setRows=rstate[1];
  var resstate = useState(null);
  var res=resstate[0], setRes=resstate[1];
  var errstate = useState('');
  var err=errstate[0], setErr=errstate[1];
  var busystate = useState(false);
  var busy=busystate[0], setBusy=busystate[1];
  var fileRef = useRef();

  var diams = [];
  rows.forEach(function(r){ if(diams.indexOf(r.diameter)<0) diams.push(r.diameter); });
  var colorMap = {};
  diams.forEach(function(d,i){ colorMap[d]=COLORS[i%COLORS.length]; });

  function upd(id,f,v){ setRows(function(rs){ return rs.map(function(row){ return row.id===id ? Object.assign({},row,{[f]:v}) : row; }); }); }

  function calculate() {
    setErr('');
    var valid = rows.filter(function(r){ return r.diameter>0&&r.thickness>0&&r.count>0&&r.length>0; });
    if (!valid.length) { setErr('–ù–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π'); return; }
    var v = VEHICLES[vKey];
    var bad = valid.filter(function(r){ return r.diameter > v.w; });
    if (bad.length) { setErr('–î–∏–∞–º–µ—Ç—Ä '+bad[0].diameter+' –º–º –ø—Ä–µ–≤—ã—à–∞–µ—Ç —à–∏—Ä–∏–Ω—É '+v.name+' ('+v.w+' –º–º)'); return; }
    setBusy(true);
    setTimeout(function(){
      try {
        var positions = valid.map(function(r){
          return {id:r.id,name:r.name,diameter:r.diameter,thickness:r.thickness,
            length:r.length,count:r.count,rho:getMat(r.material).rho};
        });
        setRes({vehicles:optimizeLoading(positions,vKey), positions:positions, vKey:vKey});
      } catch(e){ setErr('–û—à–∏–±–∫–∞: '+e.message); }
      setBusy(false);
    }, 30);
  }

  function loadFile(file) {
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(e){
      try {
        var data = JSON.parse(e.target.result);
        if (!data.positions) throw new Error('–ù–µ—Ç –ø–æ–ª—è positions');
        var nr = data.positions.map(function(p){
          var d=p.diameter, t=p.thickness;
          if (!d && p.name) { var m=p.name.match(/(\d+)[—Öx√ó](\d+)/i); if(m){d=+m[1];t=+m[2];} }
          var len=p.length||12000, cnt=p.count||0;
          if (!len&&p.totalMeters) len=p.totalMeters<6?p.totalMeters*1000:12000;
          if (!cnt&&p.totalMeters&&len) cnt=Math.ceil(p.totalMeters/(len/1000));
          return {id:uid++,name:p.name||'',diameter:d||0,thickness:t||0,length:len,count:cnt,material:'steel'};
        }).filter(function(r){ return r.diameter>0; });
        setRows(nr); setErr('');
      } catch(ex){ setErr('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+ex.message); }
    };
    reader.readAsText(file);
  }

  var totalW = rows.reduce(function(s,r){ return s+calcW(r.diameter,r.thickness,r.length,r.count,getMat(r.material).rho); },0);
  var v = VEHICLES[vKey];

  return (
    <div className="app">
      <h1>üî© –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ª–æ–≥–∏—Å—Ç–∏–∫–∏ —Ç—Ä—É–±</h1>
      <div className="subtitle">–†–∞—Å—á—ë—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–ª—å–Ω—ã—Ö —Ç—Ä—É–± ‚Ä¢ –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–æ–Ω–Ω–∞—è —É–∫–ª–∞–¥–∫–∞ ¬´–≤ —Å–µ–¥–ª–æ¬ª</div>

      <div className="vtabs">
        {Object.keys(VEHICLES).map(function(k){
          var vv=VEHICLES[k];
          return (
            <button key={k} className={"tab"+(vKey===k?' active':'')} onClick={function(){ setVKey(k); setRes(null); }}>
              {vv.icon} {vv.name} <span style={{opacity:.6,fontSize:10,marginLeft:6}}>{vv.w}√ó{vv.h} –º–º ¬∑ {vv.maxW/1000} —Ç</span>
            </button>
          );
        })}
      </div>

      <div className="card">
        <div className="card-title">üìã –ü–æ–∑–∏—Ü–∏–∏</div>
        <div style={{display:'flex',gap:8,flexWrap:'wrap',marginBottom:10}}>
          <button className="btn btn-primary" onClick={function(){ setRows(function(r){ return r.concat([newRow()]); }); }}>+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
          <button className="btn btn-secondary" onClick={function(){ fileRef.current.click(); }}>üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</button>
          <input ref={fileRef} type="file" accept=".json,.txt" style={{display:'none'}} onChange={function(e){ loadFile(e.target.files[0]); e.target.value=''; }}/>
          {rows.length>1 && <button className="btn btn-secondary" style={{fontSize:11,padding:'4px 10px'}} onClick={function(){ setRows([newRow()]); setRes(null); }}>‚úï –û—á–∏—Å—Ç–∏—Ç—å</button>}
        </div>
        <div style={{overflowX:'auto'}}>
          <table>
            <thead>
              <tr>
                <th style={{width:24}}>#</th>
                <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                <th style={{width:85}}>√ò, –º–º</th>
                <th style={{width:80}}>–°—Ç–µ–Ω–∫–∞, –º–º</th>
                <th style={{width:105}}>–î–ª–∏–Ω–∞</th>
                <th style={{width:75}}>–ö–æ–ª-–≤–æ</th>
                <th style={{width:115}}>–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
                <th style={{width:75}}>–∫–≥/–º</th>
                <th style={{width:80}}>–í–µ—Å, —Ç</th>
                <th style={{width:32}}></th>
              </tr>
            </thead>
            <tbody>
              {rows.map(function(row,i){
                var m=getMat(row.material);
                var wpm=calcWpm(row.diameter,row.thickness,m.rho);
                var wt=calcW(row.diameter,row.thickness,row.length,row.count,m.rho)/1000;
                var oversized=row.diameter>v.w;
                return (
                  <tr key={row.id} style={oversized?{background:'#1a0a0a'}:{}}>
                    <td style={{color:'#555',textAlign:'center'}}>{i+1}</td>
                    <td><input type="text" value={row.name} onChange={function(e){ upd(row.id,'name',e.target.value); }} placeholder="–¢—Ä—É–±–∞ 219√ó6..."/></td>
                    <td>
                      <input type="number" value={row.diameter} min={10} onChange={function(e){ upd(row.id,'diameter',+e.target.value||0); }} onFocus={function(e){ e.target.select(); }}
                        style={oversized?{borderColor:'#ef4444',color:'#ef4444'}:{}}/>
                      {oversized && <div style={{color:'#ef4444',fontSize:9,marginTop:1}}>‚ö† √ò &gt; {v.w} –º–º</div>}
                    </td>
                    <td><input type="number" value={row.thickness} min={1} step={0.5} onChange={function(e){ upd(row.id,'thickness',+e.target.value||0); }} onFocus={function(e){ e.target.select(); }}/></td>
                    <td>
                      <select value={row.length} onChange={function(e){ upd(row.id,'length',+e.target.value); }}>
                        <option value={6000}>6 000 –º–º</option>
                        <option value={12000}>12 000 –º–º</option>
                      </select>
                    </td>
                    <td><input type="number" value={row.count} min={1} onChange={function(e){ upd(row.id,'count',Math.max(1,Math.ceil(+e.target.value||1))); }} onFocus={function(e){ e.target.select(); }}/></td>
                    <td>
                      <select value={row.material} onChange={function(e){ upd(row.id,'material',e.target.value); }}>
                        {MATERIALS.map(function(m){ return <option key={m.id} value={m.id}>{m.name}</option>; })}
                      </select>
                    </td>
                    <td style={{color:'#888',textAlign:'right'}}>{wpm.toFixed(2)}</td>
                    <td style={{color:colorMap[row.diameter]||'#888',textAlign:'right',fontWeight:600}}>{wt.toFixed(3)}</td>
                    <td><button className="btn btn-danger" onClick={function(){ setRows(function(rs){ return rs.filter(function(x){ return x.id!==row.id; }); }); }}>‚úï</button></td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
        <div style={{marginTop:12,display:'flex',gap:12,alignItems:'center',flexWrap:'wrap'}}>
          <button className="btn btn-primary" onClick={calculate} disabled={busy} style={{minWidth:160}}>
            {busy?'‚è≥ –†–∞—Å—á—ë—Ç...':'‚ö° –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É'}
          </button>
          <span style={{color:'#555',fontSize:11}}>
            –ò—Ç–æ–≥–æ: {rows.reduce(function(s,r){ return s+r.count; },0)} —à—Ç ¬∑ {(totalW/1000).toFixed(3)} —Ç
          </span>
        </div>
      </div>

      {err && <div className="err">‚ö† {err}</div>}

      {res && (function(){
        var allLoaded=res.vehicles.reduce(function(s,vr){ return s+vr.loaded.reduce(function(ss,p){ return ss+p.loaded; },0); },0);
        var allTotal=res.positions.reduce(function(s,p){ return s+p.count; },0);
        var leftover=allTotal-allLoaded;
        var totalWLoaded=res.vehicles.reduce(function(s,vr){ return s+vr.totalWeight; },0);
        return (
          <div>
            <div className="card">
              <div className="card-title">üìä –ò—Ç–æ–≥–∏</div>
              <div className="stat-grid">
                <div className="stat"><div className="stat-val">{res.vehicles.length}</div><div className="stat-label">{VEHICLES[res.vKey].icon} {VEHICLES[res.vKey].name}</div></div>
                <div className="stat"><div className="stat-val">{(totalWLoaded/1000).toFixed(2)}</div><div className="stat-label">–¢–æ–Ω–Ω –∑–∞–≥—Ä—É–∂–µ–Ω–æ</div></div>
                <div className="stat"><div className="stat-val">{allLoaded}</div><div className="stat-label">–¢—Ä—É–± –∑–∞–≥—Ä—É–∂–µ–Ω–æ</div></div>
                <div className="stat"><div className="stat-val">{res.positions.length}</div><div className="stat-label">–ü–æ–∑–∏—Ü–∏–π</div></div>
                {leftover>0 && <div className="stat" style={{borderColor:'#ef444488'}}><div className="stat-val" style={{color:'#ef4444'}}>{leftover}</div><div className="stat-label">–ù–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è</div></div>}
              </div>
            </div>

            {res.vehicles.map(function(vr,i){
              var pct=Math.min(100,vr.totalWeight/VEHICLES[res.vKey].maxW*100);
              return (
                <div key={i} className="card">
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8,flexWrap:'wrap',gap:8}}>
                    <span style={{color:'#D97706',fontWeight:700,fontSize:14}}>{VEHICLES[res.vKey].icon} {VEHICLES[res.vKey].name} ‚Ññ{vr.number}</span>
                    <div style={{display:'flex',gap:8,alignItems:'center',flexWrap:'wrap'}}>
                      <span className="nbadge">‚öñ {(vr.totalWeight/1000).toFixed(2)} —Ç / {VEHICLES[res.vKey].maxW/1000} —Ç</span>
                      <span style={{color:'#555',fontSize:10}}>{pct.toFixed(0)}% –ø–æ –≤–µ—Å—É</span>
                      <span style={{color:'#555',fontSize:10}}>‚Üï {Math.round(vr.usedH)} / {VEHICLES[res.vKey].h} –º–º</span>
                    </div>
                  </div>
                  <div className="pbar-wrap">
                    <div className="pbar" style={{width:pct+'%',background:pct>95?'#ef4444':'#D97706'}}/>
                  </div>
                  <div style={{overflowX:'auto',marginBottom:14}}>
                    <table>
                      <thead><tr><th>–ü–æ–∑–∏—Ü–∏—è</th><th>√ò√ó—Å—Ç–µ–Ω–∫–∞</th><th>–î–ª–∏–Ω–∞</th><th>–ö–æ–ª-–≤–æ</th><th>–í–µ—Å, —Ç</th></tr></thead>
                      <tbody>
                        {vr.loaded.map(function(p,j){
                          return (
                            <tr key={j}>
                              <td style={{color:'#888'}}>{p.name||('–¢—Ä—É–±–∞ '+p.diameter+'√ó'+p.thickness)}</td>
                              <td><span style={{color:colorMap[p.diameter]||'#888',fontWeight:600}}>√ò{p.diameter}√ó{p.thickness}</span></td>
                              <td>{p.length/1000} –º</td>
                              <td style={{color:'#D97706',fontWeight:600}}>{p.loaded} —à—Ç</td>
                              <td>{(p.wPerPipe*p.loaded/1000).toFixed(3)} —Ç</td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                  <div style={{display:'flex',gap:20,flexWrap:'wrap'}}>
                    <div>
                      <div style={{color:'#555',fontSize:10,marginBottom:4}}>–í–ò–î –°–ü–ï–†–ï–î–ò (—Å–µ—á–µ–Ω–∏–µ)</div>
                      <VizFront pipes={vr.pipes} vKey={res.vKey} colorMap={colorMap}/>
                    </div>
                    <div>
                      <div style={{color:'#555',fontSize:10,marginBottom:4}}>–í–ò–î –°–ë–û–ö–£</div>
                      <VizSide pipes={vr.pipes} vKey={res.vKey} colorMap={colorMap}/>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        );
      })()}

      <div style={{color:'#2a2a2a',fontSize:10,textAlign:'center',marginTop:16,paddingBottom:8}}>
        –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ª–æ–≥–∏—Å—Ç–∏–∫–∏ —Ç—Ä—É–± v3.0 ‚Ä¢ –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–æ–Ω–Ω–∞—è —É–∫–ª–∞–¥–∫–∞
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App, null));
</script>
</body>
</html>
