<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ĞšĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€ Ğ»Ğ¾Ğ³Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ñ‚Ñ€ÑƒĞ±</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0F0F0F;color:#E5E5E5;font-family:'JetBrains Mono',monospace;font-size:13px}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:#1a1a1a}::-webkit-scrollbar-thumb{background:#D97706;border-radius:3px}
.app{max-width:1400px;margin:0 auto;padding:16px}
h1{color:#D97706;font-size:20px;font-weight:700;margin-bottom:4px}
.subtitle{color:#666;font-size:11px;margin-bottom:20px}
.card{background:#1a1a1a;border:1px solid #2a2a2a;border-radius:8px;padding:16px;margin-bottom:16px}
.card-title{color:#D97706;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
.vtabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.tab{padding:8px 16px;border:1px solid #333;border-radius:6px;cursor:pointer;background:#111;color:#888;font-family:inherit;font-size:11px;transition:all .2s;white-space:nowrap}
.tab.active{background:#D97706;color:#000;border-color:#D97706;font-weight:600}
table{width:100%;border-collapse:collapse}
th{color:#888;font-size:11px;font-weight:500;text-align:left;padding:6px 8px;border-bottom:1px solid #2a2a2a;white-space:nowrap}
td{padding:4px;border-bottom:1px solid #1f1f1f;vertical-align:middle}
input[type=number],input[type=text],select{background:#111;border:1px solid #2a2a2a;color:#E5E5E5;padding:5px 8px;border-radius:4px;font-family:inherit;font-size:12px;width:100%;outline:none}
input:focus,select:focus{border-color:#D97706}
select option{background:#1a1a1a}
.btn{padding:7px 16px;border-radius:5px;border:none;cursor:pointer;font-family:inherit;font-size:12px;font-weight:600;transition:all .2s}
.btn-primary{background:#D97706;color:#000}.btn-primary:hover{background:#f59e0b}
.btn-secondary{background:#2a2a2a;color:#E5E5E5;border:1px solid #333}.btn-secondary:hover{background:#333}
.btn-danger{background:transparent;color:#ef4444;border:1px solid #ef444455;padding:4px 10px;font-size:11px}.btn-danger:hover{background:#ef444422}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px}
.stat{background:#111;border:1px solid #2a2a2a;border-radius:6px;padding:12px}
.stat-val{font-size:24px;font-weight:700;color:#D97706}
.stat-label{color:#666;font-size:10px;margin-top:2px}
.nbadge{display:inline-block;background:#1f2d1a;color:#4ade80;border:1px solid #4ade8033;padding:2px 8px;border-radius:10px;font-size:10px}
.err{background:#1a0a0a;border:1px solid #ef4444;border-radius:6px;padding:10px 14px;color:#ef4444;font-size:11px;margin-bottom:12px}
.warn{background:#1a1200;border:1px solid #f59e0b;border-radius:6px;padding:10px 14px;color:#f59e0b;font-size:11px;margin-bottom:8px}
.pbar-wrap{height:6px;background:#1f1f1f;border-radius:3px;overflow:hidden;margin-bottom:12px}
.pbar{height:100%;border-radius:3px;transition:width .5s}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
var useState = React.useState;
var useRef = React.useRef;

var VEHICLES = {
  truck:  { name:'Ğ¤ÑƒÑ€Ğ°',          icon:'ğŸš›', l:13600, w:2440, h:2580, maxW:22000 },
  wagon:  { name:'ĞŸĞ¾Ğ»ÑƒĞ²Ğ°Ğ³Ğ¾Ğ½',     icon:'ğŸšƒ', l:12680, w:2830, h:2170, maxW:63000 },
  c20:    { name:'20-Ñ„ÑƒÑ‚. ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€', icon:'ğŸ“¦', l:5867,  w:2352, h:2393, maxW:21700 },
  c40:    { name:'40-Ñ„ÑƒÑ‚. ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€', icon:'ğŸ“¦', l:12032, w:2350, h:2390, maxW:26680 },
  c45:    { name:'45-Ñ„ÑƒÑ‚. ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€', icon:'ğŸ“¦', l:13513, w:2444, h:2549, maxW:27600 }
};

var MATERIALS = [
  {id:'steel',rho:7850,name:'Ğ¡Ñ‚Ğ°Ğ»ÑŒ'},{id:'stainless',rho:7900,name:'ĞĞµÑ€Ğ¶Ğ°Ğ²ĞµĞ¹ĞºĞ°'},
  {id:'copper',rho:8900,name:'ĞœĞµĞ´ÑŒ'},{id:'aluminum',rho:2700,name:'ĞĞ»ÑĞ¼Ğ¸Ğ½Ğ¸Ğ¹'},
  {id:'brass',rho:8500,name:'Ğ›Ğ°Ñ‚ÑƒĞ½ÑŒ'},{id:'titanium',rho:4500,name:'Ğ¢Ğ¸Ñ‚Ğ°Ğ½'},
  {id:'cast_iron',rho:7200,name:'Ğ§ÑƒĞ³ÑƒĞ½'},{id:'nickel',rho:8900,name:'ĞĞ¸ĞºĞµĞ»ÑŒ'},
  {id:'zinc',rho:7130,name:'Ğ¦Ğ¸Ğ½Ğº'},{id:'lead',rho:11340,name:'Ğ¡Ğ²Ğ¸Ğ½ĞµÑ†'}
];
var COLORS=['#60a5fa','#fbbf24','#4ade80','#fb923c','#a78bfa','#34d399','#f472b6','#f87171','#38bdf8','#e879f9'];

function getMat(id){ return MATERIALS.find(function(m){return m.id===id;})||MATERIALS[0]; }
function calcWpm(D,t,rho){ return Math.PI*t*(D-t)/1e6*rho; }
function calcW(D,t,L,n,rho){ return calcWpm(D,t,rho)*(L/1000)*n; }

// â”€â”€â”€ Gravity Simulator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gravSim(W, H, initPipes) {
  var pipes = initPipes ? initPipes.map(function(p){return {cx:p.cx,cy:p.cy,r:p.r,diameter:p.diameter,posId:p.posId};}) : [];

  function findY(cx, r) {
    var best = r;
    for (var i=0; i<pipes.length; i++) {
      var p=pipes[i], dx=Math.abs(cx-p.cx), md=r+p.r;
      if (dx<md) { var c=p.cy+Math.sqrt(md*md-dx*dx); if(c>best) best=c; }
    }
    return best;
  }

  function bestPos(r) {
    var cands=[r, W-r];
    for (var i=0; i<pipes.length; i++) {
      var p=pipes[i];
      cands.push(p.cx-p.r-r);
      cands.push(p.cx+p.r+r);
      for (var j=i+1; j<pipes.length; j++) {
        var q=pipes[j], a=p.r+r, b=q.r+r, D=Math.abs(p.cx-q.cx);
        if (D<a+b && D>Math.abs(a-b)) {
          cands.push(p.cx+(D*D+a*a-b*b)/(2*D)*(q.cx>p.cx?1:-1));
        }
      }
    }
    var best=null;
    for (var k=0; k<cands.length; k++) {
      var cx=cands[k];
      if (cx-r<-0.1||cx+r>W+0.1) continue;
      var cy=findY(cx,r);
      if (cy+r>H+0.1) continue;
      var ok=true;
      for (var m=0; m<pipes.length; m++) {
        var pp=pipes[m], ddx=cx-pp.cx, ddy=cy-pp.cy;
        if (Math.sqrt(ddx*ddx+ddy*ddy)<r+pp.r-0.5){ok=false;break;}
      }
      if (!ok) continue;
      if (!best||cy<best.cy||(Math.abs(cy-best.cy)<0.5&&cx<best.cx)) best={cx:cx,cy:cy};
    }
    return best;
  }

  return {
    getPipes: function(){return pipes;},
    calcFit: function(diameter, maxCount){
      var clone=gravSim(W,H,pipes), r=diameter/2, count=0;
      while(count<maxCount){
        var pos=clone.bestPos(r);
        if(!pos) break;
        clone.getPipes().push({cx:pos.cx,cy:pos.cy,r:r,diameter:diameter});
        count++;
      }
      return count;
    },
    bestPos: bestPos,
    commit: function(posId, diameter, maxCount){
      var r=diameter/2, placed=0;
      while(placed<maxCount){
        var pos=bestPos(r);
        if(!pos) break;
        pipes.push({cx:pos.cx,cy:pos.cy,r:r,diameter:diameter,posId:posId});
        placed++;
      }
      return placed;
    }
  };
}

// â”€â”€â”€ Load one vehicle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadVehicle(positions, vKey) {
  var v=VEHICLES[vKey];
  var sim=gravSim(v.w,v.h,[]);
  var totalWeight=0, loaded=[];

  var sorted=positions.slice().sort(function(a,b){return b.diameter-a.diameter;});
  var remaining=sorted.map(function(p){
    return {p:p, rem:p.count, rowsAlong:Math.max(1,Math.floor(v.l/p.length))};
  });

  var guard=0;
  while(guard++<200) {
    var anyPlaced=false, stillLeft=[];
    for (var i=0; i<remaining.length; i++) {
      var item=remaining[i], p=item.p, rowsAlong=item.rowsAlong;
      var wPer=calcWpm(p.diameter,p.thickness,p.rho)*(p.length/1000);
      var maxByW=wPer>0?Math.floor((v.maxW-totalWeight)/wPer):item.rem;
      var canTake=Math.min(item.rem,maxByW);
      if (canTake<1){stillLeft.push(item);continue;}
      var fitPerSection=sim.calcFit(p.diameter,Math.ceil(canTake/rowsAlong));
      var fit=Math.min(fitPerSection*rowsAlong,canTake);
      if (fit<1){stillLeft.push(item);continue;}
      var actualSection=sim.commit(p.id,p.diameter,Math.ceil(fit/rowsAlong));
      var actual=Math.min(actualSection*rowsAlong,canTake);
      if (actual<1){stillLeft.push(item);continue;}
      totalWeight+=actual*wPer;
      var ex=null;
      for(var j=0;j<loaded.length;j++){if(loaded[j].id===p.id){ex=loaded[j];break;}}
      if(ex){ex.loaded+=actual;ex.rowsAlong=rowsAlong;}
      else loaded.push({id:p.id,name:p.name,diameter:p.diameter,thickness:p.thickness,
        length:p.length,loaded:actual,wPerPipe:wPer,rho:p.rho,rowsAlong:rowsAlong});
      if(actual<item.rem) stillLeft.push({p:p,rem:item.rem-actual,rowsAlong:rowsAlong});
      anyPlaced=true;
    }
    remaining=stillLeft;
    if(!anyPlaced||remaining.length===0) break;
  }

  var pipes=sim.getPipes();
  var usedH=pipes.length?Math.max.apply(null,pipes.map(function(pp){return pp.cy+pp.r;})):0;
  return {loaded:loaded,totalWeight:totalWeight,pipes:pipes,usedH:usedH};
}

function optimizeLoading(positions, vKey) {
  var vehicles=[], rem=positions.map(function(p){return {p:p,count:p.count};});
  var guard=0;
  while(guard++<500) {
    var active=rem.filter(function(r){return r.count>0;}).map(function(r){
      return {id:r.p.id,name:r.p.name,diameter:r.p.diameter,thickness:r.p.thickness,
        length:r.p.length,rho:r.p.rho,count:r.count};
    });
    if(!active.length) break;
    var res=loadVehicle(active,vKey);
    if(!res.loaded.length) break;
    vehicles.push({number:vehicles.length+1,loaded:res.loaded,totalWeight:res.totalWeight,pipes:res.pipes,usedH:res.usedH});
    rem=rem.map(function(r){
      var l=res.loaded.find(function(x){return x.id===r.p.id;});
      return l?{p:r.p,count:r.count-l.loaded}:r;
    });
  }
  return vehicles;
}

// â”€â”€â”€ VizFront â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function VizFront(props) {
  var pipes=props.pipes, vKey=props.vKey, colorMap=props.colorMap;
  var v=VEHICLES[vKey], sc=150/v.h, W=v.w*sc, H=v.h*sc, pad=28;
  return (
    <svg width={W+pad*2} height={H+pad*2} style={{display:'block'}}>
      <rect x={pad} y={pad} width={W} height={H} fill="#0d0d0d" stroke="#444" strokeWidth={1}/>
      {pipes.map(function(p,i){
        var cx=pad+p.cx*sc, cy=pad+H-p.cy*sc, r=Math.max(p.r*sc-0.5,0.5);
        var color=colorMap[p.diameter]||'#888';
        return (
          <g key={i}>
            <circle cx={cx} cy={cy} r={r} fill={color} fillOpacity={0.75} stroke={color} strokeWidth={0.5}/>
            {r>10&&<text x={cx} y={cy+3} textAnchor="middle" fontSize={Math.min(r*0.7,10)} fill="#000" fontWeight="700" fontFamily="monospace">{p.diameter}</text>}
          </g>
        );
      })}
      <text x={pad+W/2} y={pad+H+17} textAnchor="middle" fontSize={9} fill="#555" fontFamily="monospace">{v.w} Ğ¼Ğ¼</text>
      <text x={pad-16} y={pad+H/2} textAnchor="middle" fontSize={9} fill="#555" fontFamily="monospace" transform={"rotate(-90,"+(pad-16)+","+(pad+H/2)+")"}>{v.h} Ğ¼Ğ¼</text>
    </svg>
  );
}

// â”€â”€â”€ VizSide â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function VizSide(props) {
  var vKey=props.vKey, colorMap=props.colorMap;
  var loaded=props.loaded, pipes=props.pipes;
  var v=VEHICLES[vKey], scH=150/v.h, H=v.h*scH, W=v.l*scH, pad=28;

  // Ğ ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Y-Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ñ‹ Ğ¸Ğ· pipes
  var pipeRange={};
  for (var pi=0; pi<pipes.length; pi++) {
    var pp=pipes[pi], d=pp.diameter;
    if (!pipeRange[d]) pipeRange[d]={minY:Infinity,maxY:0};
    if (pp.cy-pp.r<pipeRange[d].minY) pipeRange[d].minY=pp.cy-pp.r;
    if (pp.cy+pp.r>pipeRange[d].maxY) pipeRange[d].maxY=pp.cy+pp.r;
  }

  // Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ minY (ÑĞ½Ğ¸Ğ·Ñƒ Ğ²Ğ²ĞµÑ€Ñ…)
  var sortedL=loaded.slice().sort(function(a,b){
    var ra=pipeRange[a.diameter]||{minY:0}, rb=pipeRange[b.diameter]||{minY:0};
    return ra.minY-rb.minY;
  });

  // Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ¸Ğ½Ğ´ĞµĞºÑ ÑÑ€ĞµĞ´Ğ¸ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ Ñ Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ÑÑ‰Ğ¸Ğ¼ÑÑ Y-Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ¾Ğ¼ (Ğ´Ğ»Ñ ÑĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞµĞ¹)
  var strips=[];
  for (var i=0; i<sortedL.length; i++) {
    var lp=sortedL[i];
    var d=lp.diameter, tubeLen=lp.length, rows=lp.rowsAlong||1;
    var color=colorMap[d]||'#888';
    var range=pipeRange[d];
    if (!range) continue;

    var bW=(tubeLen/v.l)*W;
    var yTop=pad+H-range.maxY*scH;
    var h=Math.max((range.maxY-range.minY)*scH,2);

    // ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ÑĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸: ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ñ… Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ÑÑ‚ Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ Y-Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½
    var labelOffset=0;
    for (var j=0; j<i; j++) {
      var other=sortedL[j], ro=pipeRange[other.diameter];
      if (ro && ro.minY<range.maxY && ro.maxY>range.minY) labelOffset+=80;
    }

    for (var ri=0; ri<rows; ri++) {
      strips.push({
        x: pad+ri*bW, y: yTop, w: bW-1, h: h,
        color: color,
        opacity: ri%2===0?0.65:0.4,
        label: 'Ã˜'+d+' Ñ€.'+(ri+1)+' ('+tubeLen/1000+'Ğ¼)',
        labelOffset: labelOffset
      });
    }
  }

  // Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½ÑÑ‚Ğ²Ğ¾: Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ğ½ÑÑ‚Ğ°Ñ X
  var maxUsedX=pad;
  for (var si=0; si<strips.length; si++) {
    var ex2=strips[si].x+strips[si].w;
    if (ex2>maxUsedX) maxUsedX=ex2;
  }
  var freeLen=Math.round((pad+W-maxUsedX)/W*v.l);

  return (
    <svg width={W+pad*2} height={H+pad*2} style={{display:'block'}}>
      <rect x={pad} y={pad} width={W} height={H} fill="#0d0d0d" stroke="#444" strokeWidth={1}/>
      {strips.map(function(s,i){
        return (
          <g key={i}>
            <rect x={s.x} y={s.y} width={s.w} height={s.h} fill={s.color} fillOpacity={s.opacity} stroke={s.color} strokeWidth={1}/>
            <text x={s.x+6+s.labelOffset} y={s.y+12} fontSize={9} fill="#fff" fontFamily="monospace">{s.label}</text>
          </g>
        );
      })}
      {freeLen>50&&<text x={maxUsedX+8} y={pad+H/2+4} fontSize={9} fill="#666" fontFamily="monospace">{freeLen} Ğ¼Ğ¼ ÑĞ²Ğ¾Ğ±.</text>}
      <text x={pad+W/2} y={pad+H+17} textAnchor="middle" fontSize={9} fill="#555" fontFamily="monospace">{v.l} Ğ¼Ğ¼</text>
    </svg>
  );
}

// â”€â”€â”€ App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var uid=1;
function newRow(){return {id:uid++,name:'',diameter:219,thickness:6,length:12000,count:1,material:'steel'};}

function App() {
  var s1=useState('truck'); var vKey=s1[0],setVKey=s1[1];
  var s2=useState([newRow()]); var rows=s2[0],setRows=s2[1];
  var s3=useState(null); var res=s3[0],setRes=s3[1];
  var s4=useState(''); var err=s4[0],setErr=s4[1];
  var s5=useState(false); var busy=s5[0],setBusy=s5[1];
  var fileRef=useRef();

  var diams=[];
  rows.forEach(function(r){if(diams.indexOf(r.diameter)<0)diams.push(r.diameter);});
  var colorMap={};
  diams.forEach(function(d,i){colorMap[d]=COLORS[i%COLORS.length];});

  function upd(id,f,v){setRows(function(rs){return rs.map(function(row){return row.id===id?Object.assign({},row,{[f]:v}):row;});});}

  function calculate() {
    setErr('');
    var valid=rows.filter(function(r){return r.diameter>0&&r.thickness>0&&r.count>0&&r.length>0;});
    if(!valid.length){setErr('ĞĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹');return;}
    var v=VEHICLES[vKey];

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°: Ğ´Ğ»Ğ¸Ğ½Ğ° Ñ‚Ñ€ÑƒĞ±Ñ‹ > Ğ´Ğ»Ğ¸Ğ½Ñ‹ Ğ³Ñ€ÑƒĞ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½ÑÑ‚Ğ²Ğ°
    var tooLong=valid.filter(function(r){return r.length>v.l;});
    if(tooLong.length){
      setErr('âš  Ğ¢Ñ€ÑƒĞ±Ğ° '+tooLong[0].name+' ('+tooLong[0].length+' Ğ¼Ğ¼) Ğ½Ğµ Ğ²Ğ»ĞµĞ·Ğ°ĞµÑ‚ Ğ² Ğ³Ñ€ÑƒĞ·Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½ÑÑ‚Ğ²Ğ¾ '+v.name+' ('+v.l+' Ğ¼Ğ¼ Ğ¿Ğ¾ Ğ´Ğ»Ğ¸Ğ½Ğµ). Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ Ñ‚Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚ Ğ¸Ğ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ´Ğ»Ğ¸Ğ½Ñƒ.');
      return;
    }

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°: Ğ´Ğ¸Ğ°Ğ¼ĞµÑ‚Ñ€ > ÑˆĞ¸Ñ€Ğ¸Ğ½Ñ‹
    var tooWide=valid.filter(function(r){return r.diameter>v.w;});
    if(tooWide.length){setErr('Ğ”Ğ¸Ğ°Ğ¼ĞµÑ‚Ñ€ '+tooWide[0].diameter+' Ğ¼Ğ¼ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞ°ĞµÑ‚ ÑˆĞ¸Ñ€Ğ¸Ğ½Ñƒ '+v.name+' ('+v.w+' Ğ¼Ğ¼)');return;}

    setBusy(true);
    setTimeout(function(){
      try {
        var positions=valid.map(function(r){
          return {id:r.id,name:r.name,diameter:r.diameter,thickness:r.thickness,
            length:r.length,count:r.count,rho:getMat(r.material).rho};
        });
        setRes({vehicles:optimizeLoading(positions,vKey),positions:positions,vKey:vKey});
      } catch(e){setErr('ĞÑˆĞ¸Ğ±ĞºĞ°: '+e.message);}
      setBusy(false);
    },30);
  }

  function loadFile(file) {
    if(!file) return;
    var reader=new FileReader();
    reader.onload=function(e){
      try {
        var data=JSON.parse(e.target.result);
        if(!data.positions) throw new Error('ĞĞµÑ‚ Ğ¿Ğ¾Ğ»Ñ positions');
        var nr=data.positions.map(function(p){
          var d=p.diameter,t=p.thickness;
          if(!d&&p.name){var m=p.name.match(/(\d+)[Ñ…xÃ—](\d+)/i);if(m){d=+m[1];t=+m[2];}}
          var len=p.length||12000,cnt=p.count||0;
          if(!len&&p.totalMeters)len=p.totalMeters<6?p.totalMeters*1000:12000;
          if(!cnt&&p.totalMeters&&len)cnt=Math.ceil(p.totalMeters/(len/1000));
          return {id:uid++,name:p.name||'',diameter:d||0,thickness:t||0,length:len,count:cnt,material:'steel'};
        }).filter(function(r){return r.diameter>0;});
        setRows(nr);setErr('');
      } catch(ex){setErr('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸: '+ex.message);}
    };
    reader.readAsText(file);
  }

  var totalW=rows.reduce(function(s,r){return s+calcW(r.diameter,r.thickness,r.length,r.count,getMat(r.material).rho);},0);
  var v=VEHICLES[vKey];

  // ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¾ Ğ½ĞµÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ğ¸Ğ½ (Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ)
  var lengthWarnings={};
  rows.forEach(function(r){if(r.length>v.l) lengthWarnings[r.id]=true;});

  return (
    <div className="app">
      <h1>ğŸ”© ĞšĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€ Ğ»Ğ¾Ğ³Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ñ‚Ñ€ÑƒĞ±</h1>
      <div className="subtitle">Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ñ‚Ñ€ÑƒĞ± â€¢ Ğ³Ñ€Ğ°Ğ²Ğ¸Ñ‚Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ°Ñ ÑƒĞºĞ»Ğ°Ğ´ĞºĞ° Â«Ğ² ÑĞµĞ´Ğ»Ğ¾Â»</div>

      <div className="vtabs">
        {Object.keys(VEHICLES).map(function(k){
          var vv=VEHICLES[k];
          return <button key={k} className={"tab"+(vKey===k?' active':'')} onClick={function(){setVKey(k);setRes(null);setErr('');}}>
            {vv.icon} {vv.name}<br/>
            <span style={{opacity:.5,fontSize:9}}>{vv.w}Ã—{vv.h}Ğ¼Ğ¼ Â· {vv.maxW/1000}Ñ‚</span>
          </button>;
        })}
      </div>

      <div className="card">
        <div className="card-title">ğŸ“‹ ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸</div>
        <div style={{display:'flex',gap:8,flexWrap:'wrap',marginBottom:10}}>
          <button className="btn btn-primary" onClick={function(){setRows(function(r){return r.concat([newRow()]);});}}>+ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ñ€Ğ¾ĞºÑƒ</button>
          <button className="btn btn-secondary" onClick={function(){fileRef.current.click();}}>ğŸ“ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ JSON</button>
          <input ref={fileRef} type="file" accept=".json,.txt" style={{display:'none'}} onChange={function(e){loadFile(e.target.files[0]);e.target.value='';}}/>
          {rows.length>1&&<button className="btn btn-secondary" style={{fontSize:11,padding:'4px 10px'}} onClick={function(){setRows([newRow()]);setRes(null);setErr('');}}>âœ• ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ</button>}
        </div>
        <div style={{overflowX:'auto'}}>
          <table>
            <thead>
              <tr>
                <th style={{width:24}}>#</th><th>ĞĞ°Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ</th>
                <th style={{width:85}}>Ã˜, Ğ¼Ğ¼</th><th style={{width:80}}>Ğ¡Ñ‚ĞµĞ½ĞºĞ°, Ğ¼Ğ¼</th>
                <th style={{width:105}}>Ğ”Ğ»Ğ¸Ğ½Ğ°</th><th style={{width:75}}>ĞšĞ¾Ğ»-Ğ²Ğ¾</th>
                <th style={{width:115}}>ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»</th><th style={{width:75}}>ĞºĞ³/Ğ¼</th>
                <th style={{width:80}}>Ğ’ĞµÑ, Ñ‚</th><th style={{width:32}}></th>
              </tr>
            </thead>
            <tbody>
              {rows.map(function(row,i){
                var m=getMat(row.material);
                var wpm=calcWpm(row.diameter,row.thickness,m.rho);
                var wt=calcW(row.diameter,row.thickness,row.length,row.count,m.rho)/1000;
                var oversized=row.diameter>v.w;
                var tooLong=row.length>v.l;
                var rowBg=tooLong?'#1a0a0a':oversized?'#1a0a0a':'';
                return (
                  <tr key={row.id} style={rowBg?{background:rowBg}:{}}>
                    <td style={{color:'#555',textAlign:'center'}}>{i+1}</td>
                    <td><input type="text" value={row.name} onChange={function(e){upd(row.id,'name',e.target.value);}} placeholder="Ğ¢Ñ€ÑƒĞ±Ğ° 219Ã—6..."/></td>
                    <td>
                      <input type="number" value={row.diameter} min={10} onChange={function(e){upd(row.id,'diameter',+e.target.value||0);}} onFocus={function(e){e.target.select();}} style={oversized?{borderColor:'#ef4444',color:'#ef4444'}:{}}/>
                      {oversized&&<div style={{color:'#ef4444',fontSize:9,marginTop:1}}>âš  Ã˜ &gt; {v.w}Ğ¼Ğ¼</div>}
                    </td>
                    <td><input type="number" value={row.thickness} min={1} step={0.5} onChange={function(e){upd(row.id,'thickness',+e.target.value||0);}} onFocus={function(e){e.target.select();}}/></td>
                    <td>
                      <select value={row.length} onChange={function(e){upd(row.id,'length',+e.target.value);}} style={tooLong?{borderColor:'#ef4444',color:'#ef4444'}:{}}>
                        <option value={6000}>6 000 Ğ¼Ğ¼</option>
                        <option value={12000}>12 000 Ğ¼Ğ¼</option>
                      </select>
                      {tooLong&&<div style={{color:'#ef4444',fontSize:9,marginTop:1}}>âš  &gt; {v.l}Ğ¼Ğ¼</div>}
                    </td>
                    <td><input type="number" value={row.count} min={1} onChange={function(e){upd(row.id,'count',Math.max(1,Math.ceil(+e.target.value||1)));}} onFocus={function(e){e.target.select();}}/></td>
                    <td>
                      <select value={row.material} onChange={function(e){upd(row.id,'material',e.target.value);}}>
                        {MATERIALS.map(function(m){return <option key={m.id} value={m.id}>{m.name}</option>;})}
                      </select>
                    </td>
                    <td style={{color:'#888',textAlign:'right'}}>{wpm.toFixed(2)}</td>
                    <td style={{color:colorMap[row.diameter]||'#888',textAlign:'right',fontWeight:600}}>{wt.toFixed(3)}</td>
                    <td><button className="btn btn-danger" onClick={function(){setRows(function(rs){return rs.filter(function(x){return x.id!==row.id;});});}}>âœ•</button></td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
        <div style={{marginTop:12,display:'flex',gap:12,alignItems:'center',flexWrap:'wrap'}}>
          <button className="btn btn-primary" onClick={calculate} disabled={busy} style={{minWidth:160}}>
            {busy?'â³ Ğ Ğ°ÑÑ‡Ñ‘Ñ‚...':'âš¡ Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ'}
          </button>
          <span style={{color:'#555',fontSize:11}}>Ğ˜Ñ‚Ğ¾Ğ³Ğ¾: {rows.reduce(function(s,r){return s+r.count;},0)} ÑˆÑ‚ Â· {(totalW/1000).toFixed(3)} Ñ‚</span>
        </div>
      </div>

      {err&&<div className="err">âš  {err}</div>}

      {res&&(function(){
        var allLoaded=res.vehicles.reduce(function(s,vr){return s+vr.loaded.reduce(function(ss,p){return ss+p.loaded;},0);},0);
        var allTotal=res.positions.reduce(function(s,p){return s+p.count;},0);
        var leftover=allTotal-allLoaded;
        var totalWL=res.vehicles.reduce(function(s,vr){return s+vr.totalWeight;},0);
        return (
          <div>
            <div className="card">
              <div className="card-title">ğŸ“Š Ğ˜Ñ‚Ğ¾Ğ³Ğ¸</div>
              <div className="stat-grid">
                <div className="stat"><div className="stat-val">{res.vehicles.length}</div><div className="stat-label">{VEHICLES[res.vKey].icon} {VEHICLES[res.vKey].name}</div></div>
                <div className="stat"><div className="stat-val">{(totalWL/1000).toFixed(2)}</div><div className="stat-label">Ğ¢Ğ¾Ğ½Ğ½ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾</div></div>
                <div className="stat"><div className="stat-val">{allLoaded}</div><div className="stat-label">Ğ¢Ñ€ÑƒĞ± Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾</div></div>
                <div className="stat"><div className="stat-val">{res.positions.length}</div><div className="stat-label">ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹</div></div>
                {leftover>0&&<div className="stat" style={{borderColor:'#ef444488'}}><div className="stat-val" style={{color:'#ef4444'}}>{leftover}</div><div className="stat-label">ĞĞµ Ğ¿Ğ¾Ğ¼ĞµÑ‰Ğ°ĞµÑ‚ÑÑ</div></div>}
              </div>
            </div>
            {res.vehicles.map(function(vr,vi){
              var pct=Math.min(100,vr.totalWeight/VEHICLES[res.vKey].maxW*100);
              return (
                <div key={vi} className="card">
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8,flexWrap:'wrap',gap:8}}>
                    <span style={{color:'#D97706',fontWeight:700,fontSize:14}}>{VEHICLES[res.vKey].icon} {VEHICLES[res.vKey].name} â„–{vr.number}</span>
                    <div style={{display:'flex',gap:8,alignItems:'center',flexWrap:'wrap'}}>
                      <span className="nbadge">âš– {(vr.totalWeight/1000).toFixed(2)} Ñ‚ / {VEHICLES[res.vKey].maxW/1000} Ñ‚</span>
                      <span style={{color:'#555',fontSize:10}}>{pct.toFixed(0)}% Ğ¿Ğ¾ Ğ²ĞµÑÑƒ</span>
                      <span style={{color:'#555',fontSize:10}}>â†• {Math.round(vr.usedH)} / {VEHICLES[res.vKey].h} Ğ¼Ğ¼</span>
                    </div>
                  </div>
                  <div className="pbar-wrap"><div className="pbar" style={{width:pct+'%',background:pct>95?'#ef4444':'#D97706'}}/></div>
                  <div style={{overflowX:'auto',marginBottom:14}}>
                    <table>
                      <thead><tr><th>ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ</th><th>Ã˜Ã—ÑÑ‚ĞµĞ½ĞºĞ°</th><th>Ğ”Ğ»Ğ¸Ğ½Ğ°</th><th>Ğ ÑĞ´Ğ¾Ğ² Ğ¿Ğ¾ Ğ´Ğ»Ğ¸Ğ½Ğµ</th><th>ĞšĞ¾Ğ»-Ğ²Ğ¾</th><th>Ğ’ĞµÑ, Ñ‚</th></tr></thead>
                      <tbody>
                        {vr.loaded.map(function(p,j){
                          return (
                            <tr key={j}>
                              <td style={{color:'#888'}}>{p.name||('Ğ¢Ñ€ÑƒĞ±Ğ° '+p.diameter+'Ã—'+p.thickness)}</td>
                              <td><span style={{color:colorMap[p.diameter]||'#888',fontWeight:600}}>Ã˜{p.diameter}Ã—{p.thickness}</span></td>
                              <td>{p.length/1000} Ğ¼</td>
                              <td style={{color:'#555',fontSize:11}}>{p.rowsAlong||1}</td>
                              <td style={{color:'#D97706',fontWeight:600}}>{p.loaded} ÑˆÑ‚</td>
                              <td>{(p.wPerPipe*p.loaded/1000).toFixed(3)} Ñ‚</td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                  <div style={{display:'flex',gap:20,flexWrap:'wrap'}}>
                    <div>
                      <div style={{color:'#555',fontSize:10,marginBottom:4}}>Ğ’Ğ˜Ğ” Ğ¡ĞŸĞ•Ğ Ğ•Ğ”Ğ˜ (ÑĞµÑ‡ĞµĞ½Ğ¸Ğµ)</div>
                      <VizFront pipes={vr.pipes} vKey={res.vKey} colorMap={colorMap}/>
                    </div>
                    <div style={{overflowX:'auto'}}>
                      <div style={{color:'#555',fontSize:10,marginBottom:4}}>Ğ’Ğ˜Ğ” Ğ¡Ğ‘ĞĞšĞ£</div>
                      <VizSide loaded={vr.loaded} pipes={vr.pipes} vKey={res.vKey} colorMap={colorMap}/>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        );
      })()}
      <div style={{color:'#2a2a2a',fontSize:10,textAlign:'center',marginTop:16,paddingBottom:8}}>ĞšĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€ Ğ»Ğ¾Ğ³Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ñ‚Ñ€ÑƒĞ± v20</div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App,null));
</script>
</body>
</html>
